# Triage Messages Metadata Schema

## Overview
The `triage_messages.metadata` column stores structured data for different types of messages in the AI triage system.

## Metadata Types

### 1. Regular AI Message
Used for standard AI responses with risk assessment.

```json
{
  "risk_level": "low" | "moderate" | "high" | "emergency",
  "red_flags": ["flag1", "flag2"]
}
```

**Example:**
```json
{
  "risk_level": "low",
  "red_flags": []
}
```

---

### 2. OTC Recommendation Message
Used when AI recommends over-the-counter medications.

```json
{
  "type": "otc",
  "suggestions": [
    {
      "name": string,        // Medication name (e.g., "Paracetamol")
      "code": string,        // Product code/slug (e.g., "paracetamol-500mg")
      "strength": string,    // Dosage strength (e.g., "500mg")
      "dose": string,        // Dose per intake (e.g., "1 tablet")
      "frequency": string,   // Frequency with times (e.g., "3x sehari (08:00, 14:00, 20:00)")
      "duration": string,    // Duration (e.g., "3 hari atau hingga demam turun")
      "notes": string,       // Instructions (e.g., "Konsumsi sesudah makan dengan air")
      "rationale": string    // Why this medication (e.g., "Antipiretik lini pertama...")
    }
  ]
}
```

**Example:**
```json
{
  "type": "otc",
  "suggestions": [
    {
      "name": "Paracetamol",
      "code": "paracetamol-500mg",
      "strength": "500mg",
      "dose": "1 tablet",
      "frequency": "3x sehari (08:00, 14:00, 20:00)",
      "duration": "3 hari atau hingga demam turun",
      "notes": "Konsumsi sesudah makan dengan segelas air putih. Hindari alkohol. Jika demam tidak turun dalam 3 hari, konsultasi dokter.",
      "rationale": "Antipiretik lini pertama untuk menurunkan demam dengan profil keamanan yang baik"
    },
    {
      "name": "Klorfeniramina",
      "code": "chlorpheniramine-4mg",
      "strength": "4mg",
      "dose": "1 tablet",
      "frequency": "2x sehari (08:00, 20:00)",
      "duration": "2 hari atau hingga gejala pilek hilang",
      "notes": "Dapat menyebabkan kantuk. Hindari mengemudi setelah konsumsi.",
      "rationale": "Antihistamin untuk meredakan gejala pilek dan alergi"
    }
  ]
}
```

---

### 3. Appointment Message
Used when AI recommends booking a doctor appointment.

```json
{
  "type": "appointment"
}
```

**Example:**
```json
{
  "type": "appointment"
}
```

---

### 4. User Message
Used for tracking client-side message IDs.

```json
{
  "client_id": string  // Client-side message ID for deduplication
}
```

**Example:**
```json
{
  "client_id": "msg-user-1730131200000"
}
```

---

## Database Schema

### Table: `public.triage_messages`

```sql
create table public.triage_messages (
  id bigint generated by default as identity primary key,
  session_id uuid not null references public.triage_sessions(id) on delete cascade,
  role text not null check (role in ('user', 'ai', 'system', 'doctor')),
  content text not null,
  metadata jsonb not null default '{}'::jsonb,
  created_at timestamptz not null default now()
);
```

### Indexes

```sql
-- Index for querying by metadata type
create index triage_messages_metadata_type_idx 
  on public.triage_messages using gin ((metadata -> 'type'));

-- Index for querying OTC suggestions
create index triage_messages_metadata_suggestions_idx 
  on public.triage_messages using gin ((metadata -> 'suggestions'));

-- Index for session lookup
create index triage_messages_session_idx 
  on public.triage_messages (session_id);
```

---

## Usage Examples

### Query OTC Messages
```sql
select * from public.triage_messages
where metadata->>'type' = 'otc'
  and session_id = 'your-session-id';
```

### Query Messages with Red Flags
```sql
select * from public.triage_messages
where metadata->'red_flags' != '[]'::jsonb
  and session_id = 'your-session-id';
```

### Get All Medication Suggestions for a Session
```sql
select 
  m.id,
  m.created_at,
  jsonb_array_elements(m.metadata->'suggestions') as suggestion
from public.triage_messages m
where m.metadata->>'type' = 'otc'
  and m.session_id = 'your-session-id';
```

---

## API Integration

### Save OTC Message
```typescript
// POST /api/triage/message
{
  "sessionId": "uuid",
  "role": "ai",
  "content": "",
  "metadata": {
    "type": "otc",
    "suggestions": [...]
  }
}
```

### Restore Messages with Metadata
```typescript
// GET /api/triage/session
const { data } = await supabase
  .from('triage_messages')
  .select('*')
  .eq('session_id', sessionId)
  .order('created_at', { ascending: true });

// Messages include full metadata
data.forEach(message => {
  if (message.metadata?.type === 'otc') {
    // Render OTC bubble
    renderOTCBubble(message.metadata.suggestions);
  }
});
```

---

## Client-Side Rendering

### React Component
```typescript
// Render based on metadata type
{messages.map((message) => {
  // OTC Bubble
  if (message.metadata?.type === 'otc') {
    return (
      <OTCBubble 
        suggestions={message.metadata.suggestions} 
        timestamp={message.timestamp} 
      />
    );
  }
  
  // Appointment Bubble
  if (message.metadata?.type === 'appointment') {
    return (
      <AppointmentBubble 
        summary={summary} 
        onClose={() => {}} 
      />
    );
  }
  
  // Regular Message
  return <ChatMessage {...message} />;
})}
```

---

## Migration History

- **20251024160000**: Initial triage tables with metadata column
- **20251024170000**: Move tables to public schema
- **20251028220000**: Add indexes and documentation for OTC metadata

---

## Notes

1. **Metadata is required**: Default value is `'{}'::jsonb`
2. **GIN indexes**: Used for efficient JSONB queries
3. **Type safety**: Client should validate metadata structure
4. **Extensibility**: New metadata types can be added without schema changes
5. **Performance**: Indexes on `metadata->'type'` and `metadata->'suggestions'` for fast queries
